#! /bin/bash

# 1. run nix flake update
# 2. git add the updated flake.lock
nix-update() {
  local flake_dir="/home/khernand/Documents/code/nixos-config"

  if [ -d "$flake_dir" ]; then
    pushd "$flake_dir" > /dev/null

    echo "🔄 Updating Nix flake..."
    nix flake update

    if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
      git add flake.lock
      echo "✅ flake.lock added to Git."
    else
      echo "⚠ Warning: Not a Git repository, skipping Git add."
    fi

    popd > /dev/null
  else
    echo "❌ Error: Flake directory not found: $flake_dir"
  fi
}

# 1. git add all files in the nixos-config directory
# 2. run the rebuild
nix-rebuild() {
  local flake_dir="/home/khernand/Documents/code/nixos-config"

  if [ -d "$flake_dir" ]; then
    pushd "$flake_dir" > /dev/null

    if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
      git add .
      echo "✅ All changes added to Git."
    else
      echo "⚠ Warning: Not a Git repository, skipping Git add."
    fi

    echo "🛠 Running NixOS rebuild..."
    sudo nixos-rebuild switch --flake "$flake_dir#desktop"

    popd > /dev/null
  else
    echo "❌ Error: Flake directory not found: $flake_dir"
  fi
}

# Update and rebuild NixOS configuration
nix-full-update() {
  nix-update
  nix-rebuild
}

# Persist changes to the NixOS configuration
nix-persist() {
  local flake_dir="/home/khernand/Documents/code/nixos-config"
  local branch="main"  # Change this if you use a different branch

  if [ -d "$flake_dir" ]; then
    pushd "$flake_dir" > /dev/null

    if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
      git commit -m "chore(nix): Auto-update $(date -I)"
      git push origin "$branch"
      echo "🚀 Changes committed and pushed to $branch."
    else
      echo "⚠ Warning: Not a Git repository, skipping commit and push."
    fi

    popd > /dev/null
  else
    echo "❌ Error: Flake directory not found: $flake_dir"
  fi
}

nix-update-dotfiles() {
  local flake_dir="/home/khernand/Documents/code/nixos-config"

  if [ -d "$flake_dir" ]; then
    pushd "$flake_dir" > /dev/null

    echo "🔄 Updating flake input: dotfiles..."
    nix flake update --update-input dotfiles

    if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
      git add flake.lock
      echo "✅ Updated and added flake.lock for dotfiles"
    else
      echo "⚠ Warning: Not a Git repository, skipping Git add."
    fi

    echo "🛠 Running NixOS rebuild..."
    sudo nixos-rebuild switch --flake "$flake_dir#desktop"

    popd > /dev/null

    echo "🚀 Running nix-persist..."
    nix-persist  # Ensure nix-persist is defined in your shell
  else
    echo "❌ Error: Flake directory not found: $flake_dir"
  fi
}
